<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚¡ã‚¤ãƒ«æŒ¯ã‚Šåˆ†ã‘ãƒãƒƒãƒä½œæˆãƒ„ãƒ¼ãƒ« (è¨­å®šä¿å­˜æ©Ÿèƒ½ä»˜ã)</title>
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body {
            font-family: 'BIZ UDPGothic', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
            font-size: 16px;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* --- ã‚³ãƒ³ãƒ†ãƒŠ --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #ffffff;
            border: 1px solid #c0c0c0;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header h1 {
            font-size: 24px;
            color: #1a237e;
            border-bottom: 2px solid #1a237e;
            padding-bottom: 10px;
            margin-top: 0;
        }

        header p, .section-description {
            font-size: 15px;
            line-height: 1.7;
            background-color: #eef2f5;
            padding: 15px;
            border-left: 5px solid #64b5f6;
            margin-bottom: 15px;
        }
        
        /* --- å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- */
        .section {
            margin-top: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
            padding-left: 10px;
        }

        /* --- è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ --- */
        .settings-io {
            background-color: #f9f9f9;
            border: 1px dashed #aaa;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* --- ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹å…¥åŠ› --- */
        .folder-path-input {
            width: 98%;
            padding: 8px;
            font-size: 15px;
            font-family: inherit;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* --- ãƒ«ãƒ¼ãƒ«å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ« --- */
        .rules-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #999;
        }

        .rules-table th, .rules-table td {
            border: 1px solid #999;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }

        .rules-table th {
            background-color: #e0e0e0;
            font-weight: bold;
        }

        .rules-table input[type="text"] {
            width: 98%;
            padding: 8px;
            font-size: 15px;
            font-family: inherit;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* --- ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        .btn {
            font-family: inherit;
            font-size: 15px;
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn:hover { opacity: 0.85; }

        .btn-add { background-color: #28a745; }
        .btn-delete { background-color: #dc3545; padding: 8px 12px; }
        .btn-export { background-color: #ff8f00; }
        .btn-import { background-color: #42a5f5; }
        .btn-generate { background-color: #007bff; font-size: 18px; width: 100%; padding: 15px; }
        .btn-copy { background-color: #6c757d; }
        .btn-download { background-color: #17a2b8; }
        
        .action-area { text-align: center; margin-top: 20px; }
        
        #result-code {
            width: 100%;
            height: 300px;
            margin-top: 10px;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #ccc;
            background-color: #fdfdfd;
            box-sizing: border-box;
        }
        
        .result-actions { margin-top: 15px; }
        .result-actions .btn { margin-right: 10px; }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ãƒ•ã‚¡ã‚¤ãƒ«æŒ¯ã‚Šåˆ†ã‘ãƒãƒƒãƒä½œæˆãƒ„ãƒ¼ãƒ« (è¨­å®šä¿å­˜æ©Ÿèƒ½ä»˜ã)</h1>
            <p>
                æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åˆ¥ã®ãƒ•ã‚©ãƒ«ãƒ€ã¸<b>å®‰å…¨ã«</b>è‡ªå‹•ã§æŒ¯ã‚Šåˆ†ã‘ã‚‹ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚<br>
                å…¥åŠ›ã—ãŸå†…å®¹ã¯è‡ªå‹•ã§ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€æ¬¡å›ã‚‚åŒã˜çŠ¶æ…‹ã§å§‹ã‚ã‚‰ã‚Œã¾ã™ã€‚
            </p>
        </header>

        <main>
            <div class="section">
                <h2 class="section-title">è¨­å®šã®ä¿å­˜ã¨å¾©å…ƒ</h2>
                <div class="settings-io">
                    <button id="export-btn" class="btn btn-export">ç¾åœ¨ã®è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—</button>
                    <button id="import-btn" class="btn btn-import">è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">1. ç§»å‹•å…ƒãƒ•ã‚©ãƒ«ãƒ€ã®è¨­å®š</h2>
                <div class="section-description">
                    ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã•ã›ãŸã„å…ƒã®ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚
                </div>
                <input type="text" id="source-folder-input" class="folder-path-input">
            </div>

            <div class="section">
                <h2 class="section-title">2. æŒ¯ã‚Šåˆ†ã‘ãƒ«ãƒ¼ãƒ«è¨­å®š</h2>
                <div class="section-description">
                    <b>ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ‘ã‚¿ãƒ¼ãƒ³</b>ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ãŒã™ã¹ã¦å¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚<br>
                    ï¼ˆä¾‹: ã€Œ<code>æ¥­å‹™æ—¥å ±</code>ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ã€Œ<code>*æ¥­å‹™æ—¥å ±*</code>ã€ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ï¼‰
                </div>
                <table class="rules-table">
                    <thead>
                        <tr>
                            <th style="width: 45%;">ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ‘ã‚¿ãƒ¼ãƒ³ (ç§»å‹•å…ƒãƒ•ã‚©ãƒ«ãƒ€å†…)</th>
                            <th style="width: 45%;">ç§»å‹•å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ•ãƒ«ãƒ‘ã‚¹</th>
                            <th style="width: 10%;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rules-body">
                        <!-- ãƒ«ãƒ¼ãƒ«å…¥åŠ›è¡Œã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </tbody>
                </table>
                <div class="action-area">
                    <button id="add-rule-btn" class="btn btn-add">ï¼‹ ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹</button>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">3. ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h2>
                <div class="options-area">
                    <label>
                        <input type="checkbox" id="option-create-folder" checked> ç§»å‹•å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã„å ´åˆã«è‡ªå‹•ã§ä½œæˆã™ã‚‹
                    </label>
                    <label>
                        <input type="checkbox" id="option-pause" checked> å®Ÿè¡Œå¾Œã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã™ãã«é–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹
                    </label>
                </div>
            </div>

            <div class="section">
                <button id="generate-btn" class="btn btn-generate">âš™ï¸ ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹</button>
            </div>
        </main>

        <footer>
            <div id="result-area" class="section" style="display:none;">
                <h2 class="section-title">ç”Ÿæˆçµæœ</h2>
                <textarea id="result-code" readonly></textarea>
                <div class="result-actions">
                    <button id="copy-btn" class="btn btn-copy">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
                    <button id="download-btn" class="btn btn-download">ğŸ’¾ .batãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const STORAGE_KEY = 'fileOrganizerSettings';
            const DEFAULT_SOURCE_FOLDER = '%USERPROFILE%\\Downloads';

            const sourceFolderInput = document.getElementById('source-folder-input');
            const rulesBody = document.getElementById('rules-body');
            // ... (ä»–ã®è¦ç´ å–å¾—ã¯çœç•¥) ...
            const addRuleBtn = document.getElementById('add-rule-btn');
            const generateBtn = document.getElementById('generate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            const resultArea = document.getElementById('result-area');
            const resultCode = document.getElementById('result-code');


            // --- é–¢æ•°å®šç¾© ---

            // ç¾åœ¨ã®å…¨è¨­å®šã‚’localStorageã«ä¿å­˜ã™ã‚‹
            const saveSettings = () => {
                const rules = [];
                const rows = rulesBody.getElementsByTagName('tr');
                for (let row of rows) {
                    const pattern = row.cells[0].querySelector('input').value.trim();
                    const folderPath = row.cells[1].querySelector('input').value.trim();
                    if(pattern || folderPath) {
                        rules.push({ pattern, folderPath });
                    }
                }
                const settings = {
                    sourceFolder: sourceFolderInput.value.trim(),
                    rules: rules
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            };
            
            // UIã«è¨­å®šã‚’é©ç”¨ã™ã‚‹
            const applySettings = (settings) => {
                 sourceFolderInput.value = (settings && settings.sourceFolder) ? settings.sourceFolder : DEFAULT_SOURCE_FOLDER;
                 rulesBody.innerHTML = '';
                 const rules = (settings && Array.isArray(settings.rules)) ? settings.rules : [];
                 if (rules.length > 0) {
                    rules.forEach(rule => addRuleRow(rule.pattern, rule.folderPath));
                 } else {
                    addRuleRow();
                 }
            };
            
            // localStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹
            const loadSettings = () => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                let settings = null;
                try {
                    if (savedData) {
                        settings = JSON.parse(savedData);
                        if (Array.isArray(settings)) {
                            settings = { sourceFolder: DEFAULT_SOURCE_FOLDER, rules: settings };
                        }
                    }
                } catch(e) { console.error("è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e); }
                applySettings(settings);
            };

            // æ–°ã—ã„ãƒ«ãƒ¼ãƒ«è¡Œã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
            const addRuleRow = (pattern = '', folderPath = '') => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" placeholder="ä¾‹: æ¥­å‹™æ—¥å ±" value="${pattern}"></td>
                    <td><input type="text" placeholder="ä¾‹: D:\\æ›¸é¡\\æ—¥å ±" value="${folderPath}"></td>
                    <td style="text-align: center;"><button class="btn btn-delete">å‰Šé™¤</button></td>
                `;
                rulesBody.appendChild(row);
            };

            // ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
            const generateBatchFile = () => {
                saveSettings();
                let script = `@echo off\n`;
                script += `chcp 65001 > nul\n`;
                script += `setlocal enabledelayedexpansion\n\n`;
                
                const sourceFolder = sourceFolderInput.value.trim() || DEFAULT_SOURCE_FOLDER;
                script += `rem --- ç§»å‹•å…ƒãƒ•ã‚©ãƒ«ãƒ€: ${sourceFolder} ---\n\n`;
                script += `rem --- æŒ¯ã‚Šåˆ†ã‘å‡¦ç† ---\n`;
                
                const createFolder = document.getElementById('option-create-folder').checked;
                const rows = rulesBody.getElementsByTagName('tr');

                for (let row of rows) {
                    let patternRaw = row.cells[0].querySelector('input').value.trim();
                    const folderPath = row.cells[1].querySelector('input').value.trim();

                    if (patternRaw && folderPath) {
                        
                        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                        // â˜… æ”¹ä¿®ç‚¹: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°è‡ªå‹•ã§ä»˜ä¸ â˜…
                        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                        let finalPattern = patternRaw;
                        if (!patternRaw.includes('*') && !patternRaw.includes('?')) {
                            finalPattern = `*${patternRaw}*`;
                        }
                        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

                        const destinationFolder = folderPath;
                        script += `\nrem --- [ãƒ«ãƒ¼ãƒ«] ã€Œ${patternRaw}ã€ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ${destinationFolder}ã€ã¸å®‰å…¨ã«ç§»å‹• ---\n`;
                        if (createFolder) {
                            script += `if not exist "${destinationFolder}" (mkdir "${destinationFolder}")\n`;
                        }
                        script += `for %%F in ("${sourceFolder}\\${finalPattern}") do (\n`;
                        script += `    echo.\n`;
                        script += `    echo [å‡¦ç†å¯¾è±¡] "%%~nxF"\n`;
                        script += `    copy "%%F" "${destinationFolder}\\" > nul\n`;
                        script += `    fc /b "%%F" "${destinationFolder}\\%%~nxF" > nul\n`;
                        script += `    if !errorlevel! == 0 (\n`;
                        script += `        echo   ...OKã€‚å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n`;
                        script += `        del "%%F"\n`;
                        script += `    ) else (\n`;
                        script += `        echo   ...[è­¦å‘Š] æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¡æ–¹æ®‹ã—ã¾ã™ã€‚\n`;
                        script += `    )\n`;
                        script += `)\n`;
                    }
                }
                
                script += `\nrem --- å‡¦ç†å®Œäº† ---\n`;
                script += `echo.\necho å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n`;
                if (document.getElementById('option-pause').checked) {
                    script += `pause\n`;
                }
                resultCode.value = script;
                resultArea.style.display = 'block';
                resultArea.scrollIntoView({ behavior: 'smooth' });
            };

            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š --- (å¤‰æ›´ãªã—)

            sourceFolderInput.addEventListener('input', saveSettings);
            rulesBody.addEventListener('input', saveSettings);
            rulesBody.addEventListener('change', saveSettings);
            addRuleBtn.addEventListener('click', () => { addRuleRow(); saveSettings(); });
            rulesBody.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('btn-delete')) {
                    e.target.closest('tr').remove();
                    saveSettings();
                }
            });
            exportBtn.addEventListener('click', () => {
                saveSettings();
                const settingsJson = localStorage.getItem(STORAGE_KEY);
                const blob = new Blob([settingsJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'rules_backup.json'; a.click(); URL.revokeObjectURL(url);
            });
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let settings = JSON.parse(e.target.result);
                        if (Array.isArray(settings)) { settings = { sourceFolder: DEFAULT_SOURCE_FOLDER, rules: settings }; }
                        else if (typeof settings !== 'object' || !settings.hasOwnProperty('rules')) { throw new Error("ç„¡åŠ¹ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚"); }
                        applySettings(settings); saveSettings(); alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
                    } catch (error) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); console.error(error); }
                };
                reader.readAsText(file); event.target.value = '';
            });
            generateBtn.addEventListener('click', generateBatchFile);
            copyBtn.addEventListener('click', () => { resultCode.select(); document.execCommand('copy'); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'); });
            downloadBtn.addEventListener('click', () => {
                const text = resultCode.value.replace(/\n/g, "\r\n");
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'safe_file_organizer.bat'; a.click(); URL.revokeObjectURL(url);
            });
            
            // --- åˆæœŸåŒ–å‡¦ç† ---
            loadSettings();
        });
    </script>
</body>
</html>