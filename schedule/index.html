<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 30px;
}

.controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}

.left-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.right-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.view-toggle {
    display: flex;
    gap: 5px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 4px;
}

.toggle-btn {
    padding: 8px 20px;
    border: none;
    background: transparent;
    color: white;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s;
    font-size: 14px;
}

.toggle-btn.active {
    background: white;
    color: #667eea;
    font-weight: bold;
}

.year-selector,
.month-selector {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(255, 255, 255, 0.2);
    padding: 8px 15px;
    border-radius: 8px;
}

.nav-btn {
    background: rgba(255, 255, 255, 0.3);
    border: none;
    color: white;
    cursor: pointer;
    padding: 5px 12px;
    border-radius: 5px;
    font-size: 16px;
    transition: all 0.3s;
}

.nav-btn:hover {
    background: rgba(255, 255, 255, 0.5);
}

.year-display,
.month-display {
    font-size: 18px;
    font-weight: bold;
    min-width: 80px;
    text-align: center;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    font-weight: 500;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
}

.schedule-container {
    padding: 20px 30px;
    overflow-x: auto;
}

.schedule-wrapper {
    display: flex;
    min-width: 100%;
}

.items-column {
    min-width: 200px;
    border-right: 2px solid #dee2e6;
    position: sticky;
    left: 0;
    background: white;
    z-index: 10;
}

.items-header {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.item-row {
    height: 60px;
    display: flex;
    align-items: center;
    padding: 0 10px;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px;
    position: relative;
    cursor: move;
    transition: background 0.2s;
}

.item-row:hover {
    background: #f8f9fa;
}

.item-row.dragging {
    opacity: 0.5;
    background: #e9ecef;
}

.item-row.drag-over {
    border-top: 3px solid #667eea;
}

.item-name {
    flex: 1;
    padding: 5px;
    cursor: pointer;
}

.item-name:hover {
    background: #e9ecef;
    border-radius: 3px;
}

.item-delete-btn {
    background: #dc3545;
    border: none;
    color: white;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 11px;
    transition: all 0.2s;
    margin-left: 5px;
}

.item-delete-btn:hover {
    background: #c82333;
}

.schedule-delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(220, 53, 69, 0.9);
    border: none;
    color: white;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.2s;
}

.schedule-bar:hover .schedule-delete-btn {
    opacity: 1;
}

.schedule-repeat-icon {
    position: absolute;
    top: 2px;
    left: 2px;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: bold;
}

.timeline-column {
    flex: 1;
    overflow-x: auto;
}

.timeline-header {
    height: 50px;
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.timeline-cell {
    min-width: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 500;
    border-right: 1px solid #e9ecef;
    position: relative;
}

.timeline-cell.month-header {
    min-width: 90px;
    font-weight: bold;
}

.timeline-cell.saturday {
    background: #e3f2fd;
    color: #1976d2;
}

.timeline-cell.sunday,
.timeline-cell.holiday {
    background: #ffebee;
    color: #d32f2f;
}

.timeline-body {
    position: relative;
}

.timeline-row {
    height: 60px;
    display: flex;
    border-bottom: 1px solid #e9ecef;
    position: relative;
}

.timeline-grid-cell {
    min-width: 80px;
    border-right: 1px solid #f1f3f5;
}

.timeline-grid-cell.saturday {
    background: #e3f2fd;
}

.timeline-grid-cell.sunday,
.timeline-grid-cell.holiday {
    background: #ffebee;
}

.schedule-bar {
    position: absolute;
    height: 40px;
    top: 10px;
    background: #3498db;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    padding: 0 10px;
    color: white;
    font-size: 12px;
    font-weight: 500;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.schedule-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 255, 255, 0.6);
}

.schedule-bar-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.2s;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.modal-content h2 {
    margin-bottom: 20px;
    color: #333;
}

.input-field {
    width: 100%;
    padding: 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 15px;
    transition: border-color 0.3s;
}

.input-field:focus {
    outline: none;
    border-color: #667eea;
}

.date-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.date-inputs label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #495057;
}

.color-picker {
    margin-bottom: 15px;
}

.color-picker label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #495057;
}

.color-picker input {
    width: 100px;
    height: 40px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
}

.repeat-settings {
    margin-bottom: 15px;
}

.repeat-settings label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #495057;
}

#repeatCountContainer {
    margin-bottom: 15px;
}

#repeatCountContainer label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #495057;
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 768px) {
    .controls {
        flex-direction: column;
        align-items: stretch;
    }

    .toolbar {
        flex-wrap: wrap;
    }

    .items-column {
        min-width: 150px;
    }

    .timeline-cell {
        min-width: 60px;
        font-size: 10px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="controls">
                <div class="left-controls">
                    <div class="view-toggle">
                        <button class="toggle-btn active" data-view="year">å¹´é–“</button>
                        <button class="toggle-btn" data-view="month">æœˆé–“</button>
                    </div>
                    <div class="year-selector">
                        <button id="prevYear" class="nav-btn">â—€</button>
                        <span id="currentYear" class="year-display">ï¼’ï¼ï¼’ï¼•</span>
                        <button id="nextYear" class="nav-btn">â–¶</button>
                    </div>
                    <div class="month-selector" style="display: none;">
                        <button id="prevMonth" class="nav-btn">â—€</button>
                        <span id="currentMonth" class="month-display">ï¼’ï¼ï¼’ï¼•å¹´ï¼‘ï¼æœˆ</span>
                        <button id="nextMonth" class="nav-btn">â–¶</button>
                    </div>
                </div>
                <div class="right-controls">
                    <button id="addItemBtn" class="btn btn-primary">é …ç›®ã‚’è¿½åŠ </button>
                    <button id="addScheduleBtn" class="btn btn-secondary">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ </button>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                    <button id="importBtn" class="btn btn-info">CSVå–è¾¼</button>
                    <button id="exportBtn" class="btn btn-info">CSVå‡ºåŠ›</button>
                </div>
            </div>
        </header>

        <div class="schedule-container">
            <div class="schedule-wrapper">
                <div class="items-column">
                    <div class="items-header">é …ç›®</div>
                    <div class="items-list" id="itemsList">
                        <!-- é …ç›®ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                <div class="timeline-column">
                    <div class="timeline-header" id="timelineHeader">
                        <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    <div class="timeline-body" id="timelineBody">
                        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é …ç›®è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <h2>é …ç›®ã‚’è¿½åŠ </h2>
            <input type="text" id="itemName" placeholder="é …ç›®åã‚’å…¥åŠ›" class="input-field">
            <div class="modal-actions">
                <button id="saveItemBtn" class="btn btn-primary">ä¿å­˜</button>
                <button id="cancelItemBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <h2>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ </h2>
            <select id="scheduleItem" class="input-field">
                <option value="">é …ç›®ã‚’é¸æŠ</option>
            </select>
            <div class="date-inputs">
                <div>
                    <label>é–‹å§‹æ—¥</label>
                    <input type="date" id="startDate" class="input-field">
                </div>
                <div>
                    <label>çµ‚äº†æ—¥</label>
                    <input type="date" id="endDate" class="input-field">
                </div>
            </div>
            <input type="text" id="scheduleTitle" placeholder="ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«" class="input-field">
            <div class="color-picker">
                <label>ã‚«ãƒ©ãƒ¼</label>
                <input type="color" id="scheduleColor" value="#3498db">
            </div>
            <div class="repeat-settings">
                <label>ç¹°ã‚Šè¿”ã—</label>
                <select id="repeatPattern" class="input-field">
                    <option value="none">ãªã—</option>
                    <option value="monthly">æ¯æœˆ</option>
                    <option value="bimonthly">2ãƒ¶æœˆãŠã</option>
                    <option value="quarterly">3ãƒ¶æœˆãŠã</option>
                    <option value="semiannual">åŠå¹´ãŠã</option>
                </select>
            </div>
            <div id="repeatCountContainer" style="display: none;">
                <label>ç¹°ã‚Šè¿”ã—å›æ•°</label>
                <input type="number" id="repeatCount" class="input-field" min="1" max="24" value="6" placeholder="ç¹°ã‚Šè¿”ã—å›æ•°">
                <small style="color: #6c757d; font-size: 12px;">æœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å«ã‚ã¦ä½•å›ç¹°ã‚Šè¿”ã™ã‹</small>
            </div>
            <div class="modal-actions">
                <button id="saveScheduleBtn" class="btn btn-primary">ä¿å­˜</button>
                <button id="cancelScheduleBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
// ãƒ‡ãƒ¼ã‚¿ç®¡ç†
let currentView = 'year'; // 'year' or 'month'
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-11
let items = [];
let schedules = [];
let editingElement = null;
let draggedItemIndex = null;

// æ—¥æœ¬ã®ç¥æ—¥ï¼ˆ2025å¹´ï¼‰
const holidays = {
    2025: [
        '2025-01-01', // å…ƒæ—¥
        '2025-01-13', // æˆäººã®æ—¥
        '2025-02-11', // å»ºå›½è¨˜å¿µã®æ—¥
        '2025-02-23', // å¤©çš‡èª•ç”Ÿæ—¥
        '2025-02-24', // æŒ¯æ›¿ä¼‘æ—¥
        '2025-03-20', // æ˜¥åˆ†ã®æ—¥
        '2025-04-29', // æ˜­å’Œã®æ—¥
        '2025-05-03', // æ†²æ³•è¨˜å¿µæ—¥
        '2025-05-04', // ã¿ã©ã‚Šã®æ—¥
        '2025-05-05', // ã“ã©ã‚‚ã®æ—¥
        '2025-05-06', // æŒ¯æ›¿ä¼‘æ—¥
        '2025-07-21', // æµ·ã®æ—¥
        '2025-08-11', // å±±ã®æ—¥
        '2025-09-15', // æ•¬è€ã®æ—¥
        '2025-09-23', // ç§‹åˆ†ã®æ—¥
        '2025-10-13', // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥
        '2025-11-03', // æ–‡åŒ–ã®æ—¥
        '2025-11-23', // å‹¤åŠ´æ„Ÿè¬ã®æ—¥
        '2025-11-24', // æŒ¯æ›¿ä¼‘æ—¥
    ],
    2026: [
        '2026-01-01', // å…ƒæ—¥
        '2026-01-12', // æˆäººã®æ—¥
        '2026-02-11', // å»ºå›½è¨˜å¿µã®æ—¥
        '2026-02-23', // å¤©çš‡èª•ç”Ÿæ—¥
        '2026-03-20', // æ˜¥åˆ†ã®æ—¥
        '2026-04-29', // æ˜­å’Œã®æ—¥
        '2026-05-03', // æ†²æ³•è¨˜å¿µæ—¥
        '2026-05-04', // ã¿ã©ã‚Šã®æ—¥
        '2026-05-05', // ã“ã©ã‚‚ã®æ—¥
        '2026-05-06', // æŒ¯æ›¿ä¼‘æ—¥
        '2026-07-20', // æµ·ã®æ—¥
        '2026-08-11', // å±±ã®æ—¥
        '2026-09-21', // æ•¬è€ã®æ—¥
        '2026-09-22', // ç§‹åˆ†ã®æ—¥
        '2026-10-12', // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥
        '2026-11-03', // æ–‡åŒ–ã®æ—¥
        '2026-11-23', // å‹¤åŠ´æ„Ÿè¬ã®æ—¥
    ]
};

// ç¥æ—¥ãƒã‚§ãƒƒã‚¯
function isHoliday(year, month, day) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    return holidays[year] && holidays[year].includes(dateStr);
}

// DOMè¦ç´ 
const yearSelector = document.querySelector('.year-selector');
const monthSelector = document.querySelector('.month-selector');
const currentYearEl = document.getElementById('currentYear');
const currentMonthEl = document.getElementById('currentMonth');
const itemsList = document.getElementById('itemsList');
const timelineHeader = document.getElementById('timelineHeader');
const timelineBody = document.getElementById('timelineBody');

// ãƒ¢ãƒ¼ãƒ€ãƒ«
const itemModal = document.getElementById('itemModal');
const scheduleModal = document.getElementById('scheduleModal');

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    setupEventListeners();
    render();
});

// ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetSaveScheduleButton() {
    const saveBtn = document.getElementById('saveScheduleBtn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    newSaveBtn.addEventListener('click', () => {
        const itemId = parseInt(document.getElementById('scheduleItem').value);
        const title = document.getElementById('scheduleTitle').value.trim();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const color = document.getElementById('scheduleColor').value;
        const repeatPattern = document.getElementById('repeatPattern').value;
        const repeatCount = parseInt(document.getElementById('repeatCount').value) || 1;

        if (itemId && title && startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = end - start; // æœŸé–“ï¼ˆãƒŸãƒªç§’ï¼‰
            
            if (repeatPattern === 'none') {
                // ç¹°ã‚Šè¿”ã—ãªã—
                schedules.push({
                    id: Date.now(),
                    itemId: itemId,
                    title: title,
                    startDate: start,
                    endDate: end,
                    color: color,
                    repeatGroupId: null
                });
            } else {
                // ç¹°ã‚Šè¿”ã—ã‚ã‚Š
                const repeatGroupId = Date.now();
                const monthsIncrement = getMonthsIncrement(repeatPattern);
                
                for (let i = 0; i < repeatCount; i++) {
                    const newStart = new Date(start);
                    newStart.setMonth(newStart.getMonth() + (monthsIncrement * i));
                    
                    const newEnd = new Date(newStart.getTime() + duration);
                    
                    schedules.push({
                        id: Date.now() + i + Math.random(),
                        itemId: itemId,
                        title: title,
                        startDate: newStart,
                        endDate: newEnd,
                        color: color,
                        repeatGroupId: repeatGroupId,
                        repeatPattern: repeatPattern,
                        repeatIndex: i,
                        repeatTotal: repeatCount
                    });
                }
            }
            
            saveData();
            scheduleModal.classList.remove('active');
            render();
        } else {
            alert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
    });
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
function setupEventListeners() {
    // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentView = btn.dataset.view;
            
            if (currentView === 'year') {
                yearSelector.style.display = 'flex';
                monthSelector.style.display = 'none';
            } else {
                yearSelector.style.display = 'none';
                monthSelector.style.display = 'flex';
            }
            
            render();
        });
    });

    // å¹´åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('prevYear').addEventListener('click', () => {
        currentYear--;
        render();
    });

    document.getElementById('nextYear').addEventListener('click', () => {
        currentYear++;
        render();
    });

    // æœˆåˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('prevMonth').addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        render();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        render();
    });

    // é …ç›®è¿½åŠ 
    document.getElementById('addItemBtn').addEventListener('click', () => {
        itemModal.classList.add('active');
        document.getElementById('itemName').value = '';
    });

    document.getElementById('saveItemBtn').addEventListener('click', () => {
        const name = document.getElementById('itemName').value.trim();
        if (name) {
            items.push({
                id: Date.now(),
                name: name
            });
            saveData();
            itemModal.classList.remove('active');
            render();
        }
    });

    document.getElementById('cancelItemBtn').addEventListener('click', () => {
        itemModal.classList.remove('active');
    });

    // ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³å¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('repeatPattern').addEventListener('change', (e) => {
        const repeatCountContainer = document.getElementById('repeatCountContainer');
        if (e.target.value !== 'none') {
            repeatCountContainer.style.display = 'block';
        } else {
            repeatCountContainer.style.display = 'none';
        }
    });

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 
    document.getElementById('addScheduleBtn').addEventListener('click', () => {
        if (items.length === 0) {
            alert('ã¾ãšé …ç›®ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
            return;
        }
        
        const select = document.getElementById('scheduleItem');
        select.innerHTML = '<option value="">é …ç›®ã‚’é¸æŠ</option>';
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            select.appendChild(option);
        });
        
        scheduleModal.classList.add('active');
        document.getElementById('scheduleTitle').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('scheduleColor').value = '#3498db';
        document.getElementById('repeatPattern').value = 'none';
        document.getElementById('repeatPattern').disabled = false; // æœ‰åŠ¹åŒ–
        document.getElementById('repeatCount').value = '6';
        document.getElementById('repeatCountContainer').style.display = 'none';
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    resetSaveScheduleButton();

    document.getElementById('cancelScheduleBtn').addEventListener('click', () => {
        scheduleModal.classList.remove('active');
        // ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã‚’æœ‰åŠ¹åŒ–ï¼ˆç·¨é›†å¾Œã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ï¼‰
        document.getElementById('repeatPattern').disabled = false;
    });

    // CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    document.getElementById('importBtn').addEventListener('click', () => {
        document.getElementById('csvFileInput').click();
    });

    document.getElementById('csvFileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            importFromCSV(file);
        }
    });

    // CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    [itemModal, scheduleModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å ´åˆã¯ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã‚’æœ‰åŠ¹åŒ–
                if (modal === scheduleModal) {
                    document.getElementById('repeatPattern').disabled = false;
                }
            }
        });
    });
}

// CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function importFromCSV(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const text = e.target.result;
            const lines = text.split('\n');
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
            const dataLines = lines.slice(1).filter(line => line.trim());
            
            const newSchedules = [];
            const itemMap = new Map();
            
            dataLines.forEach(line => {
                // CSVè§£æï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const match = line.match(/"([^"]*)","([^"]*)","([^"]*)","([^"]*)","([^"]*)"/);
                if (match) {
                    const [, itemName, title, startDateStr, endDateStr, color] = match;
                    
                    // é …ç›®ã®å–å¾—ã¾ãŸã¯ä½œæˆ
                    let itemId;
                    if (itemMap.has(itemName)) {
                        itemId = itemMap.get(itemName);
                    } else {
                        const existingItem = items.find(i => i.name === itemName);
                        if (existingItem) {
                            itemId = existingItem.id;
                        } else {
                            itemId = Date.now() + Math.random();
                            items.push({
                                id: itemId,
                                name: itemName
                            });
                        }
                        itemMap.set(itemName, itemId);
                    }
                    
                    // æ—¥ä»˜ã®è§£æ
                    const startDate = new Date(startDateStr.replace(/\//g, '-'));
                    const endDate = new Date(endDateStr.replace(/\//g, '-'));
                    
                    if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                        newSchedules.push({
                            id: Date.now() + Math.random(),
                            itemId: itemId,
                            title: title,
                            startDate: startDate,
                            endDate: endDate,
                            color: color || '#3498db'
                        });
                    }
                }
            });
            
            if (newSchedules.length > 0) {
                schedules.push(...newSchedules);
                saveData();
                render();
                alert(`${newSchedules.length}ä»¶ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
            } else {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
            
        } catch (error) {
            alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('csvFileInput').value = '';
    };
    
    reader.readAsText(file, 'UTF-8');
}

// CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportToCSV() {
    let csv = '\uFEFF'; // BOM for Excel
    csv += 'é …ç›®,ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å,é–‹å§‹æ—¥,çµ‚äº†æ—¥,ã‚«ãƒ©ãƒ¼\n';
    
    schedules.forEach(schedule => {
        const item = items.find(i => i.id === schedule.itemId);
        const itemName = item ? item.name : '';
        const startDate = formatDate(schedule.startDate);
        const endDate = formatDate(schedule.endDate);
        
        csv += `"${itemName}","${schedule.title}","${startDate}","${endDate}","${schedule.color}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `schedule_${currentYear}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}/${month}/${day}`;
}

// æœˆè¡¨ç¤ºæ›´æ–°
function updateMonthDisplay() {
    const monthNames = ['ï¼‘æœˆ', 'ï¼’æœˆ', 'ï¼“æœˆ', 'ï¼”æœˆ', 'ï¼•æœˆ', 'ï¼–æœˆ', 'ï¼—æœˆ', 'ï¼˜æœˆ', 'ï¼™æœˆ', 'ï¼‘ï¼æœˆ', 'ï¼‘ï¼‘æœˆ', 'ï¼‘ï¼’æœˆ'];
    currentMonthEl.textContent = `${toFullWidth(currentYear)}å¹´${monthNames[currentMonth]}`;
    currentYearEl.textContent = toFullWidth(currentYear);
}

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function render() {
    // å¹´ãƒ»æœˆã®è¡¨ç¤ºã‚’æ›´æ–°
    currentYearEl.textContent = toFullWidth(currentYear);
    updateMonthDisplay();
    
    renderItems();
    renderTimeline();
}

// é …ç›®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderItems() {
    itemsList.innerHTML = '';
    items.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.draggable = true;
        div.dataset.index = index;
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
        div.addEventListener('dragstart', (e) => {
            draggedItemIndex = index;
            div.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        
        div.addEventListener('dragend', (e) => {
            div.classList.remove('dragging');
            draggedItemIndex = null;
            // ã™ã¹ã¦ã®é …ç›®ã‹ã‚‰ drag-over ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.item-row').forEach(row => {
                row.classList.remove('drag-over');
            });
        });
        
        div.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (draggedItemIndex !== null && draggedItemIndex !== index) {
                div.classList.add('drag-over');
            }
        });
        
        div.addEventListener('dragleave', (e) => {
            div.classList.remove('drag-over');
        });
        
        div.addEventListener('drop', (e) => {
            e.preventDefault();
            div.classList.remove('drag-over');
            if (draggedItemIndex !== null && draggedItemIndex !== index) {
                // é …ç›®ã‚’ç§»å‹•
                const draggedItem = items[draggedItemIndex];
                items.splice(draggedItemIndex, 1);
                const newIndex = draggedItemIndex < index ? index - 1 : index;
                items.splice(newIndex, 0, draggedItem);
                saveData();
                render();
            }
        });
        
        // é …ç›®åï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ï¼‰
        const nameSpan = document.createElement('span');
        nameSpan.className = 'item-name';
        nameSpan.textContent = item.name;
        nameSpan.ondblclick = () => editItemName(item.id, nameSpan);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'item-delete-btn';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteItem(item.id);
        };
        
        div.appendChild(nameSpan);
        div.appendChild(deleteBtn);
        itemsList.appendChild(div);
    });
}

// åŠè§’æ•°å­—ã‚’å…¨è§’ã«å¤‰æ›
function toFullWidth(str) {
    return str.toString().replace(/[0-9]/g, (s) => {
        return String.fromCharCode(s.charCodeAt(0) + 0xFEE0);
    });
}

// æ›œæ—¥å–å¾—ï¼ˆå…¨è§’ï¼‰
function getWeekdayJa(date) {
    const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    return weekdays[date.getDay()];
}

// ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æœˆæ•°ã‚’å–å¾—
function getMonthsIncrement(pattern) {
    switch(pattern) {
        case 'monthly': return 1;
        case 'bimonthly': return 2;
        case 'quarterly': return 3;
        case 'semiannual': return 6;
        default: return 0;
    }
}

// ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¡¨ç¤ºå
function getRepeatPatternName(pattern) {
    switch(pattern) {
        case 'monthly': return 'æ¯æœˆ';
        case 'bimonthly': return '2ãƒ¶æœˆãŠã';
        case 'quarterly': return '3ãƒ¶æœˆãŠã';
        case 'semiannual': return 'åŠå¹´ãŠã';
        default: return '';
    }
}

// é …ç›®å‰Šé™¤
function deleteItem(itemId) {
    const item = items.find(i => i.id === itemId);
    if (!item) return;
    
    const relatedSchedules = schedules.filter(s => s.itemId === itemId);
    let message = `ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
    if (relatedSchedules.length > 0) {
        message += `\n\nã“ã®é …ç›®ã«é–¢é€£ã™ã‚‹${relatedSchedules.length}ä»¶ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`;
    }
    
    if (confirm(message)) {
        items = items.filter(i => i.id !== itemId);
        schedules = schedules.filter(s => s.itemId !== itemId);
        saveData();
        render();
    }
}

// é …ç›®åç·¨é›†
function editItemName(itemId, element) {
    if (editingElement) return;
    
    const item = items.find(i => i.id === itemId);
    if (!item) return;
    
    editingElement = element;
    const originalText = element.textContent;
    
    const input = document.createElement('input');
    input.type = 'text';
    input.value = originalText;
    input.className = 'input-field';
    input.style.width = '100%';
    input.style.margin = '0';
    
    element.textContent = '';
    element.appendChild(input);
    input.focus();
    input.select();
    
    const save = () => {
        const newValue = input.value.trim();
        if (newValue && newValue !== originalText) {
            item.name = newValue;
            saveData();
        }
        element.textContent = item.name;
        editingElement = null;
    };
    
    input.onblur = save;
    input.onkeydown = (e) => {
        if (e.key === 'Enter') {
            save();
        } else if (e.key === 'Escape') {
            element.textContent = originalText;
            editingElement = null;
        }
    };
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderTimeline() {
    if (currentView === 'year') {
        renderYearTimeline();
    } else {
        renderMonthTimeline();
    }
}

// å¹´é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
function renderYearTimeline() {
    const months = ['ï¼‘æœˆ', 'ï¼’æœˆ', 'ï¼“æœˆ', 'ï¼”æœˆ', 'ï¼•æœˆ', 'ï¼–æœˆ', 'ï¼—æœˆ', 'ï¼˜æœˆ', 'ï¼™æœˆ', 'ï¼‘ï¼æœˆ', 'ï¼‘ï¼‘æœˆ', 'ï¼‘ï¼’æœˆ'];
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    timelineHeader.innerHTML = '';
    months.forEach((month, index) => {
        const cell = document.createElement('div');
        cell.className = 'timeline-cell month-header';
        cell.textContent = month;
        timelineHeader.appendChild(cell);
    });

    // ãƒœãƒ‡ã‚£
    timelineBody.innerHTML = '';
    items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'timeline-row';
        
        // ã‚°ãƒªãƒƒãƒ‰èƒŒæ™¯
        for (let i = 0; i < 12; i++) {
            const cell = document.createElement('div');
            cell.className = 'timeline-grid-cell';
            cell.style.minWidth = '90px';
            row.appendChild(cell);
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼
        const itemSchedules = schedules.filter(s => s.itemId === item.id);
        itemSchedules.forEach(schedule => {
            if (schedule.startDate.getFullYear() === currentYear || schedule.endDate.getFullYear() === currentYear) {
                const bar = createScheduleBar(schedule, 'year');
                if (bar) {
                    row.appendChild(bar);
                }
            }
        });

        timelineBody.appendChild(row);
    });
}

// æœˆé–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
function renderMonthTimeline() {
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    timelineHeader.innerHTML = '';
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dayOfWeek = date.getDay(); // 0: æ—¥æ›œ, 6: åœŸæ›œ
        
        const cell = document.createElement('div');
        cell.className = 'timeline-cell';
        // å…¨è§’ã®æ—¥ä»˜ + åŠè§’ã‚«ãƒƒã‚³ã§æ›œæ—¥
        cell.textContent = `${toFullWidth(day)}(${getWeekdayJa(date)})`;
        
        // åœŸæ—¥ç¥æ—¥ã®è‰²é©ç”¨
        if (isHoliday(currentYear, currentMonth, day)) {
            cell.classList.add('holiday');
        } else if (dayOfWeek === 0) {
            cell.classList.add('sunday');
        } else if (dayOfWeek === 6) {
            cell.classList.add('saturday');
        }
        
        timelineHeader.appendChild(cell);
    }

    // ãƒœãƒ‡ã‚£
    timelineBody.innerHTML = '';
    items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'timeline-row';
        
        // ã‚°ãƒªãƒƒãƒ‰èƒŒæ™¯
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dayOfWeek = date.getDay();
            
            const cell = document.createElement('div');
            cell.className = 'timeline-grid-cell';
            
            // åœŸæ—¥ç¥æ—¥ã®è‰²é©ç”¨
            if (isHoliday(currentYear, currentMonth, day)) {
                cell.classList.add('holiday');
            } else if (dayOfWeek === 0) {
                cell.classList.add('sunday');
            } else if (dayOfWeek === 6) {
                cell.classList.add('saturday');
            }
            
            row.appendChild(cell);
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼
        const itemSchedules = schedules.filter(s => s.itemId === item.id);
        itemSchedules.forEach(schedule => {
            if ((schedule.startDate.getFullYear() === currentYear && schedule.startDate.getMonth() === currentMonth) ||
                (schedule.endDate.getFullYear() === currentYear && schedule.endDate.getMonth() === currentMonth) ||
                (schedule.startDate < new Date(currentYear, currentMonth, 1) && schedule.endDate > new Date(currentYear, currentMonth + 1, 0))) {
                const bar = createScheduleBar(schedule, 'month');
                if (bar) {
                    row.appendChild(bar);
                }
            }
        });

        timelineBody.appendChild(row);
    });
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼ä½œæˆ
function createScheduleBar(schedule, view) {
    const bar = document.createElement('div');
    bar.className = 'schedule-bar';
    bar.textContent = schedule.title;
    bar.style.backgroundColor = schedule.color;
    bar.dataset.scheduleId = schedule.id;

    if (view === 'year') {
        const startMonth = schedule.startDate.getMonth();
        const endMonth = schedule.endDate.getMonth();
        const startYear = schedule.startDate.getFullYear();
        const endYear = schedule.endDate.getFullYear();

        let left, width;
        
        if (startYear === currentYear && endYear === currentYear) {
            left = startMonth * 90;
            width = (endMonth - startMonth + 1) * 90;
        } else if (startYear < currentYear && endYear === currentYear) {
            left = 0;
            width = (endMonth + 1) * 90;
        } else if (startYear === currentYear && endYear > currentYear) {
            left = startMonth * 90;
            width = (12 - startMonth) * 90;
        } else if (startYear < currentYear && endYear > currentYear) {
            left = 0;
            width = 1080;
        } else {
            return null;
        }

        bar.style.left = `${left}px`;
        bar.style.width = `${width - 10}px`;
    } else {
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const startDay = schedule.startDate.getDate();
        const endDay = schedule.endDate.getDate();
        const startMonth = schedule.startDate.getMonth();
        const endMonth = schedule.endDate.getMonth();
        const startYear = schedule.startDate.getFullYear();
        const endYear = schedule.endDate.getFullYear();

        let left, width;

        if (startYear === currentYear && startMonth === currentMonth && endYear === currentYear && endMonth === currentMonth) {
            left = (startDay - 1) * 80;
            width = (endDay - startDay + 1) * 80;
        } else if ((startYear < currentYear || (startYear === currentYear && startMonth < currentMonth)) && endYear === currentYear && endMonth === currentMonth) {
            left = 0;
            width = endDay * 80;
        } else if (startYear === currentYear && startMonth === currentMonth && (endYear > currentYear || (endYear === currentYear && endMonth > currentMonth))) {
            left = (startDay - 1) * 80;
            width = (daysInMonth - startDay + 1) * 80;
        } else if ((startYear < currentYear || (startYear === currentYear && startMonth < currentMonth)) && (endYear > currentYear || (endYear === currentYear && endMonth > currentMonth))) {
            left = 0;
            width = daysInMonth * 80;
        } else {
            return null;
        }

        bar.style.left = `${left}px`;
        bar.style.width = `${width - 10}px`;
    }

    // ç¹°ã‚Šè¿”ã—ã‚¢ã‚¤ã‚³ãƒ³
    if (schedule.repeatGroupId) {
        const repeatIcon = document.createElement('span');
        repeatIcon.className = 'schedule-repeat-icon';
        repeatIcon.textContent = 'ğŸ”„';
        repeatIcon.title = `${getRepeatPatternName(schedule.repeatPattern)} (${schedule.repeatIndex + 1}/${schedule.repeatTotal})`;
        bar.appendChild(repeatIcon);
    }
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'schedule-delete-btn';
    deleteBtn.textContent = 'Ã—';
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteSchedule(schedule.id, schedule.repeatGroupId);
    };
    bar.appendChild(deleteBtn);
    
    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
    let tooltipText = `${schedule.title}\n${formatDate(schedule.startDate)} ï½ ${formatDate(schedule.endDate)}`;
    if (schedule.repeatGroupId) {
        tooltipText += `\nç¹°ã‚Šè¿”ã—: ${getRepeatPatternName(schedule.repeatPattern)} (${schedule.repeatIndex + 1}/${schedule.repeatTotal})`;
    }
    bar.title = tooltipText;
    
    // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†
    bar.ondblclick = (e) => {
        e.stopPropagation();
        editSchedule(schedule.id);
    };

    return bar;
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤
function deleteSchedule(scheduleId, repeatGroupId) {
    const schedule = schedules.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    if (repeatGroupId) {
        // ç¹°ã‚Šè¿”ã—ã‚°ãƒ«ãƒ¼ãƒ—ã®å ´åˆ
        const groupSchedules = schedules.filter(s => s.repeatGroupId === repeatGroupId);
        const message = `ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ç¹°ã‚Šè¿”ã—è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nã€å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‘\n1. ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿å‰Šé™¤\n2. ç¹°ã‚Šè¿”ã—ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ï¼ˆ${groupSchedules.length}ä»¶ï¼‰ã‚’å‰Šé™¤\n\nã€ŒOKã€ã§å…¨ä½“å‰Šé™¤ã€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§å€‹åˆ¥å‰Šé™¤ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`;
        
        if (confirm(message)) {
            // å…¨ä½“å‰Šé™¤
            schedules = schedules.filter(s => s.repeatGroupId !== repeatGroupId);
        } else {
            // å€‹åˆ¥å‰Šé™¤ã®ç¢ºèª
            if (confirm(`ã€Œ${schedule.title}ã€(${schedule.repeatIndex + 1}/${schedule.repeatTotal})ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                schedules = schedules.filter(s => s.id !== scheduleId);
            } else {
                return;
            }
        }
    } else {
        // é€šå¸¸ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        if (!confirm(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€Œ${schedule.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }
        schedules = schedules.filter(s => s.id !== scheduleId);
    }
    
    saveData();
    render();
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†
function editSchedule(scheduleId) {
    const schedule = schedules.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    // ç¹°ã‚Šè¿”ã—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å ´åˆã¯è­¦å‘Š
    if (schedule.repeatGroupId) {
        const message = `ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ç¹°ã‚Šè¿”ã—è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nç·¨é›†ã™ã‚‹ã¨å…ƒã®ç¹°ã‚Šè¿”ã—ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰åˆ‡ã‚Šé›¢ã•ã‚Œã€\næ–°ãŸã«ç¹°ã‚Šè¿”ã—è¨­å®šã‚’é©ç”¨ã§ãã¾ã™ã€‚\n\nç¶šã‘ã¾ã™ã‹ï¼Ÿ`;
        if (!confirm(message)) {
            return;
        }
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å€¤ã‚’è¨­å®š
    const select = document.getElementById('scheduleItem');
    select.innerHTML = '<option value="">é …ç›®ã‚’é¸æŠ</option>';
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        option.selected = item.id === schedule.itemId;
        select.appendChild(option);
    });
    
    document.getElementById('scheduleTitle').value = schedule.title;
    document.getElementById('startDate').value = schedule.startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = schedule.endDate.toISOString().split('T')[0];
    document.getElementById('scheduleColor').value = schedule.color;
    
    // ç¹°ã‚Šè¿”ã—è¨­å®šã‚’æœ‰åŠ¹åŒ–
    document.getElementById('repeatPattern').value = 'none';
    document.getElementById('repeatPattern').disabled = false;
    document.getElementById('repeatCount').value = '6';
    document.getElementById('repeatCountContainer').style.display = 'none';
    
    scheduleModal.classList.add('active');
    
    // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã«
    const saveBtn = document.getElementById('saveScheduleBtn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    newSaveBtn.onclick = () => {
        const itemId = parseInt(document.getElementById('scheduleItem').value);
        const title = document.getElementById('scheduleTitle').value.trim();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const color = document.getElementById('scheduleColor').value;
        const repeatPattern = document.getElementById('repeatPattern').value;
        const repeatCount = parseInt(document.getElementById('repeatCount').value) || 1;

        if (itemId && title && startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = end - start; // æœŸé–“ï¼ˆãƒŸãƒªç§’ï¼‰
            
            // æ—¢å­˜ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤
            schedules = schedules.filter(s => s.id !== scheduleId);
            
            if (repeatPattern === 'none') {
                // ç¹°ã‚Šè¿”ã—ãªã—
                schedules.push({
                    id: Date.now(),
                    itemId: itemId,
                    title: title,
                    startDate: start,
                    endDate: end,
                    color: color,
                    repeatGroupId: null
                });
            } else {
                // ç¹°ã‚Šè¿”ã—ã‚ã‚Š
                const repeatGroupId = Date.now();
                const monthsIncrement = getMonthsIncrement(repeatPattern);
                
                for (let i = 0; i < repeatCount; i++) {
                    const newStart = new Date(start);
                    newStart.setMonth(newStart.getMonth() + (monthsIncrement * i));
                    
                    const newEnd = new Date(newStart.getTime() + duration);
                    
                    schedules.push({
                        id: Date.now() + i + Math.random(),
                        itemId: itemId,
                        title: title,
                        startDate: newStart,
                        endDate: newEnd,
                        color: color,
                        repeatGroupId: repeatGroupId,
                        repeatPattern: repeatPattern,
                        repeatIndex: i,
                        repeatTotal: repeatCount
                    });
                }
            }
            
            saveData();
            scheduleModal.classList.remove('active');
            
            // ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã‚’æœ‰åŠ¹åŒ–
            document.getElementById('repeatPattern').disabled = false;
            
            render();
            
            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            resetSaveScheduleButton();
        } else {
            alert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
    };
}

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜
function saveData() {
    localStorage.setItem('scheduleItems', JSON.stringify(items));
    localStorage.setItem('scheduleData', JSON.stringify(schedules.map(s => ({
        ...s,
        startDate: s.startDate.toISOString(),
        endDate: s.endDate.toISOString(),
        repeatGroupId: s.repeatGroupId || null,
        repeatPattern: s.repeatPattern || null,
        repeatIndex: s.repeatIndex ?? null,
        repeatTotal: s.repeatTotal ?? null
    }))));
}

// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
function loadData() {
    const savedItems = localStorage.getItem('scheduleItems');
    const savedSchedules = localStorage.getItem('scheduleData');
    
    if (savedItems) {
        items = JSON.parse(savedItems);
    } else {
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        items = [
            { id: 1, name: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆA' },
            { id: 2, name: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆB' },
            { id: 3, name: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆC' }
        ];
    }

    if (savedSchedules) {
        schedules = JSON.parse(savedSchedules).map(s => ({
            ...s,
            startDate: new Date(s.startDate),
            endDate: new Date(s.endDate),
            repeatGroupId: s.repeatGroupId || null,
            repeatPattern: s.repeatPattern || null,
            repeatIndex: s.repeatIndex ?? null,
            repeatTotal: s.repeatTotal ?? null
        }));
    } else {
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        schedules = [
            { 
                id: 1, 
                itemId: 1, 
                title: 'ä¼ç”»ãƒ•ã‚§ãƒ¼ã‚º', 
                startDate: new Date(2025, 0, 1), 
                endDate: new Date(2025, 2, 31),
                color: '#3498db',
                repeatGroupId: null
            },
            { 
                id: 2, 
                itemId: 1, 
                title: 'é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚º', 
                startDate: new Date(2025, 3, 1), 
                endDate: new Date(2025, 8, 30),
                color: '#2ecc71',
                repeatGroupId: null
            },
            { 
                id: 3, 
                itemId: 2, 
                title: 'è¦ä»¶å®šç¾©', 
                startDate: new Date(2025, 1, 1), 
                endDate: new Date(2025, 3, 30),
                color: '#e74c3c',
                repeatGroupId: null
            },
            { 
                id: 4, 
                itemId: 3, 
                title: 'ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º', 
                startDate: new Date(2025, 9, 1), 
                endDate: new Date(2025, 11, 31),
                color: '#f39c12',
                repeatGroupId: null
            }
        ];
    }
}
    </script>
</body>
</html>
